#!/bin/bash

# Скрипт для первичной настройки Ubuntu 2025
set -e

echo "=== 1. Установка суперпользователя ==="
sudo passwd root

echo "=== 2. Обновление системы ==="
sudo apt update && sudo apt upgrade -y
sudo apt autoremove -y
sudo apt clean

echo "=== 3. Установка основных утилит ==="
sudo apt install -y git curl vim htop tree unzip python3 python3-pip nodejs npm docker.io build-essential ufw zsh fish tlp tlp-rdw unattended-upgrades

echo "=== 4. Настройка git ==="
read -p "Введите ваше имя для git: " gitname
git config --global user.name "$gitname"
read -p "Введите ваш email для git: " gitemail
git config --global user.email "$gitemail"

echo "=== 5. Генерация SSH-ключа для git ==="
if [ ! -f ~/.ssh/id_ed25519 ]; then
  ssh-keygen -t ed25519 -C "$gitemail"
  echo
  echo "==== Ваш публичный SSH-ключ (вставьте на GitHub/GitLab!): ===="
  cat ~/.ssh/id_ed25519.pub
  echo "=============================================================="
else
  echo "SSH-ключ уже существует: ~/.ssh/id_ed25519"
fi

echo "=== 6. Безопасность: включение firewall ==="
sudo ufw enable
sudo ufw status

echo "=== 7. Улучшение энергосбережения для ноутбуков ==="
sudo systemctl enable tlp
sudo systemctl start tlp

echo "=== 8. Автоматизация обновлений ==="
sudo dpkg-reconfigure --priority=low unattended-upgrades

echo "=== 9. Добавление пользователя в группу docker ==="
sudo usermod -aG docker $USER

echo "=== 10. Настройка временной зоны ==="
sudo dpkg-reconfigure tzdata

echo "=== 11. Проверка и вывод локали ==="
locale

echo "=== 12. Установка Fish Shell по умолчанию ==="
chsh -s /usr/bin/fish
echo "==== Дефолтная оболочка изменена на fish. Перезапустите терминал для применения. ===="

echo "=== 13. (По желанию) Отключение root по SSH (если сервер) ==="
SSHD_CONFIG="/etc/ssh/sshd_config"
if grep -Eq "^PermitRootLogin yes" $SSHD_CONFIG; then
  sudo sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' $SSHD_CONFIG
  sudo systemctl restart ssh
  echo "Root-доступ по SSH отключен."
else
  echo "Отключение root по SSH не требуется или уже настроено."
fi

echo "=== Базовая настройка завершена. Не забудьте перезагрузить систему! ==="
